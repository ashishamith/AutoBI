<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AutoBI Dashboard</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
  <div class="dashboard-container">
    <header class="header">
      <div class="date-box">
        <label>From :</label>
        <div class="date-display" id="from-date">-</div>
      </div>
      <div class="title-section">
        <h1 class="logo">Auto<span>BI</span></h1>
        <p class="subtext">AI - Powered Business Intelligence</p>
      </div>
      <div class="date-box">
        <label>To :</label>
        <div class="date-display" id="to-date">-</div>
      </div>
    </header>

    <div class="ask-container">
      <input type="text" id="ask-input" placeholder="Ask Anything....?" class="ask-input">
      <button class="btn ask-btn" onclick="askQuestion()">Ask</button>
    </div>

    <div class="result-container" id="result-container"></div>

    <div class="buttons">
      <form id="csv-form" enctype="multipart/form-data">
        <input type="file" name="file" id="csv-file" accept=".csv" hidden>
        <button type="button" class="btn" onclick="document.getElementById('csv-file').click();">Choose CSV</button>
        <button type="submit" class="btn">Upload CSV</button>
      </form>
      <button class="btn" onclick="downloadReport()">Download Report</button>
      <button class="btn logout" onclick="window.location.href='/logout'">Logout</button>
    </div>
  </div>

  <script>
    document.getElementById('csv-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const fileInput = document.getElementById('csv-file');
      if (!fileInput.files.length) {
        alert("Please choose a CSV file first!");
        return;
      }
      const formData = new FormData();
      formData.append('file', fileInput.files[0]);

      const res = await fetch('/upload_csv', { method: 'POST', body: formData });
      const data = await res.json();
      if (data.success) {
        document.getElementById('from-date').textContent = data.from_date;
        document.getElementById('to-date').textContent = data.to_date;
      } else {
        alert(data.error || "Error uploading file");
      }
    });

    async function askQuestion() {
      const question = document.getElementById('ask-input').value.trim();
      const container = document.getElementById('result-container');
      container.innerHTML = "";

      if (!question) {
        alert("Please enter a question!");
        return;
      }

      const typingElem = document.createElement('pre');
      typingElem.classList.add('typing');
      container.appendChild(typingElem);

      const res = await fetch('/ask_question', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ question })
      });

      const data = await res.json();
      const text = data.answer || "No response found.";

      // Smart typing animation
      let index = 0;
      const typingSpeed = 15;

      function typeChar() {
        if (index < text.length) {
          typingElem.textContent += text.charAt(index++);
          setTimeout(typeChar, typingSpeed);
        } else {
          typingElem.classList.remove('typing');
        }
      }

      typeChar();

      if (data.graph) {
        const graph = document.createElement('div');
        graph.classList.add('graph');
        graph.innerHTML = `<img src="data:image/png;base64,${data.graph}" alt="Generated Graph" />`;
        container.appendChild(graph);
      }
    }

    function downloadReport() {
      window.location.href = '/download_report';
    }
  </script>
</body>
</html>
